<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Setup-Assistent</title>
<style>
/* -------------------- Cyberpunk / Hightech Design -------------------- */
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  font-family:'Segoe UI',Tahoma,sans-serif;
  background:#0b0c10;
  color:#fff;
}

#container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 24px 36px;
  max-width: 1200px;   /* bleibt wie bisher */
  margin-left: auto;    /* rechts ausrichten */
  margin-right: 0;
  border-radius: 16px;
  background: #1f1f2e;
  box-shadow: 0 0 30px #0ff, 0 0 50px #0ff inset;
  height: auto;
  min-height: 90vh;
}

#grid-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 24px;
  width: 100%;
  padding-bottom: 24px;
  box-sizing: border-box;
  min-height: 200px;
}

/* Neuer Single-Card Container */
#single-card-container {
  display:none;
  width:100%;
  flex:1;
  min-height:300px;
  justify-content:center;
  align-items:center;
  margin-top:20px;
}

#open-btn {
  margin-bottom: 24px;
}

#progress-wrapper {
  position: relative;
  z-index: 1;
  height: 32px;
  width: 100%;
  background: rgba(0,255,255,0.15);
  border-radius: 16px;
  overflow: hidden;
  margin-top: 12px;
  flex-shrink: 0;
}

#progress-bar {
  height: 100%;
  width: 0%;
  background: #0ff;
  border-radius: 16px 0 0 16px;
  transition: width 0.5s ease;
  position: relative;
}

#progress-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-weight: bold;
  color: #000;
  pointer-events: none;
}

#clock-container {
  position: fixed;
  top: 16px;
  left: 16px;
  font-family: 'Segoe UI', Tahoma, sans-serif;
  color: #0ff;
  z-index: 10000;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 8px;
  padding: 12px 20px;
  border-radius: 16px;
  background: rgba(31, 31, 46, 0.8); /* dunkler leicht transparenter Hintergrund */
  border: 2px solid #0ff; /* Neon-Umriss */
  box-shadow: 0 0 20px #0ff, 0 0 40px #0ff inset; /* Neon-Glow innen und au√üen */
}

#clock-date-container {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 8px; /* Uhrzeit | Datum nebeneinander */
}

#weather-container {
  display: flex;
  flex-direction: column; /* St√§dte untereinander */
  gap: 4px;
  font-size: 0.9em;
  color: #0ff;
}

.weather-city {
  display: flex;
  flex-direction: column; /* Stadt oben, Wetter darunter */
  align-items: flex-start;
  gap: 2px;
}

.weather-city img {
  width: 36px;
  height: 36px;
  filter: drop-shadow(0 0 6px #0ff) drop-shadow(0 0 12px #0ff) hue-rotate(200deg) brightness(1.2);
  transition: transform 0.3s ease, filter 0.3s ease;
}
.weather-city img:hover {
  transform: scale(1.2);
  filter: drop-shadow(0 0 12px #0ff) drop-shadow(0 0 24px #0ff) hue-rotate(200deg) brightness(1.3);
}

.card{
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  padding:36px;
  border-radius:16px;
  background:#1f1f2e;
  box-shadow:0 0 30px #0ff, 0 0 50px #0ff inset;
  height: auto;
  min-height:500px;
}

.row{
  display:flex; 
  justify-content:center; 
  gap:24px;
  margin-bottom:24px;
  flex-wrap:wrap;
}

.site-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  width: 220px;
  height: 280px;
  background: #151524;
  color: #0ff;
  border-radius: 12px;
  box-sizing: border-box;
  box-shadow: 0 0 8px #0ff, 0 0 20px #0ff inset;
  text-align: center;
}

.site-card img {
  max-width: 64px;
  max-height: 64px;
  margin: 10px 0 8px 0;
  filter: drop-shadow(0 0 6px #0ff) drop-shadow(0 0 12px #0ff);
  transition: transform 0.3s ease, filter 0.3s ease;
}

.site-card img:hover {
  transform: scale(1.1);
  filter: drop-shadow(0 0 10px #0ff) drop-shadow(0 0 20px #0ff);
}

.site-card .domain { font-size: 0.9em; margin-bottom: 12px; min-height: 1.4em; line-height:1.4em; word-break: break-word; }
.site-card .status { margin-bottom: 8px; }
.site-card button { margin-top:auto; display:block; padding:10px 20px; font-size:1em; font-weight:bold; border:none; border-radius:6px; color:#fff; background: linear-gradient(45deg,#50e3c2,#4a90e2); box-shadow:0 0 8px #0ff,0 0 20px #0ff inset; cursor:pointer; transition: all 0.3s ease; }
.site-card button:hover { transform:scale(1.05); box-shadow:0 0 12px #0ff,0 0 28px #0ff inset; }

button { padding:10px 20px; font-size:1em; font-weight:bold; border:none; border-radius:6px; color:#fff; background: linear-gradient(45deg,#50e3c2,#4a90e2); box-shadow:0 0 8px #0ff,0 0 20px #0ff inset; cursor:pointer; transition: all 0.3s ease; }
button:hover { transform:scale(1.05); box-shadow:0 0 12px #0ff,0 0 28px #0ff inset; }
#open-btn { padding:12px 20px; font-size:1em; margin-bottom:24px; }

#finalize-overlay { position:fixed; inset:0; display:flex; justify-content:center; align-items:center; background: rgba(0,0,0,0.95); z-index:9999; display:none; }
#finalize-text { font-size:2em; font-weight:bold; color:#0ff; text-shadow:0 0 10px #0ff,0 0 30px #0ff; animation:pulseFinal 1.2s ease-in-out infinite; }

@keyframes pulseFinal { 0%,100%{transform:scale(1);opacity:1;} 50%{transform:scale(1.1);opacity:0.8;} }
@keyframes fadeIn { 0%{opacity:0; transform: translateY(10px);} 100%{opacity:1; transform: translateY(0);} }
@keyframes pulseSwitch {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: 0.8; }
}
</style>
</head>
<body>
<div id="clock-container">
  <div id="clock-date-container">
    <div id="clock"></div>
    <div id="date"></div>
  </div>
  <div id="weather-container">
    <div id="city1" class="weather-city"></div>
    <div id="city2" class="weather-city"></div>
  </div>
</div>

<div id="container" class="card">
  <h2 style="text-align:center;">Setup-Assistent</h2>
  <div id="progress-wrapper">
      <div id="progress-bar"></div>
      <span id="progress-text">0%</span>
  </div>

  <div style="text-align:center; margin:20px 0;">
    <button id="open-btn" onclick="start()">Webseiten √∂ffnen</button>
  </div>

  <!-- Grid: Webseiten-Anzeigen -->
  <div id="grid-container"></div>

  <!-- Single Card Container f√ºr exakte Zentrierung -->
  <div id="single-card-container"></div>

  <div id="continue-container" style="margin-top:20px; text-align:center;"></div>
</div>

<div id="popup-hint"></div>

<!-- Overlay -->
<div id="finalize-overlay"><div id="finalize-text">‚ú® Finalisiere Setup‚Ä¶ ‚ú®</div></div>

<script>
// ----------------------- Setup-Code -----------------------
const websites = [
  {name:"Microsoft-Account", url:"https://myaccount.microsoft.com/", type:"normal", icon:"https://cdn-icons-png.flaticon.com/512/732/732221.png"},
  {name:"SharePoint", url:"https://ohvar.sharepoint.com/sites/oberlin-berufsbildungswerk", type:"normal", icon:"https://upload.wikimedia.org/wikipedia/commons/thumb/e/ec/Microsoft_Office_SharePoint_%282019%E2%80%932025%29.svg/1049px-Microsoft_Office_SharePoint_%282019%E2%80%932025%29.svg.png"},
  {name:"OneDrive", url:"https://ohvar-my.sharepoint.com/", type:"normal", icon:"https://upload.wikimedia.org/wikipedia/commons/e/e7/Microsoft_OneDrive_Icon_%282025_-_present%29.svg"},
  {name:"OneDrive", url:"https://ohvar-my.sharepoint.com/", type:"normal", icon:"https://upload.wikimedia.org/wikipedia/commons/e/e7/Microsoft_OneDrive_Icon_%282025_-_present%29.svg"},
  {name:"Outlook", url:"https://outlook.office.com/mail/", type:"outlook", icon:"https://upload.wikimedia.org/wikipedia/commons/thumb/c/cc/Microsoft_Outlook_Icon_%282025%E2%80%93present%29.svg/1200px-Microsoft_Outlook_Icon_%282025%E2%80%93present%29.svg.png"},
  {name:"WebUntis", url:"https://s200440.webuntis.com/WebUntis/?school=s200440#/basic/login", type:"normal", icon:"https://www.untis.at/fileadmin/user_upload/Icon-1024x1024_rund.png"}
];

let tabs = [];
let totalSteps = 0;
let completedSteps = 0;
let outlookIndex = -1;

function calculateTotalSteps(){ totalSteps = websites.length + 4; }

function stepCompleted(){
  completedSteps++;
  const percent = Math.min(100, Math.round((completedSteps / totalSteps) * 100));
  const bar = document.getElementById("progress-bar");
  const text = document.getElementById("progress-text");
  if(bar && text){ bar.style.width = percent + "%"; text.textContent = percent + "%"; }
}

function showFinalizeOverlay(){
  const overlay = document.getElementById("finalize-overlay");
  overlay.style.display="flex";
  document.getElementById("progress-bar").style.width="100%";
  document.getElementById("progress-text").textContent="100%";
  setTimeout(()=>{overlay.style.display="none";},1000);
}

function renderGrid(items){
  const container=document.getElementById("grid-container"); container.innerHTML="";
  const numRows=Math.ceil(Math.sqrt(items.length)); let start=0;
  for(let r=0;r<numRows;r++){
    const remaining=items.length-start;
    const remainingRows=numRows-r;
    const itemsInRow=Math.ceil(remaining/remainingRows);
    const rowDiv=document.createElement("div"); rowDiv.className="row";
    for(let i=0;i<itemsInRow;i++){
      const w=items[start+i];
      const card=document.createElement("div"); card.className="site-card"; card.style.animationDelay=`${(start+i)*0.1}s`;
      const domain=w.url.replace(/^https?:\/\//,'').replace(/\/.*$/,'');
      card.innerHTML=`<div><b>${w.name}</b></div><img src="${w.icon}" alt="${w.name}"><div class="domain">${domain}</div><div id="status-${start+i}" class="status">‚Äì</div><div id="action-${start+i}"></div>`;
      rowDiv.appendChild(card);
    }
    container.appendChild(rowDiv); start+=itemsInRow;
  }
}

function setStatus(i,text){ 
  const el=document.getElementById("status-"+i);
  el.classList.add("updating");
  setTimeout(()=>{
    el.textContent=text; 
    el.classList.remove("updating"); 
    if(text.includes("‚úÖ")) el.style.color="green"; 
    else if(text.includes("‚ùå")) el.style.color="red"; 
    else el.style.color="#0ff"; 
    checkAllClosed();
  },150); 
}

function setAction(i,html){ document.getElementById("action-"+i).innerHTML=html; }

function start(){
  calculateTotalSteps();
  tabs = [];
  let popupBlockedDetected = false;
  document.getElementById("popup-hint").innerHTML = "";
  document.getElementById("continue-container").innerHTML = "";
  renderGrid(websites);

  websites.forEach((w,i)=>{
    const win = window.open(w.url,"_blank");
    if(!win){ 
      setStatus(i,"‚ùå Blockiert"); 
      stepCompleted(); 
      popupBlockedDetected = true; 
      return; 
    }
    tabs[i] = {win,type:w.type,url:w.url};

    if(w.type === "outlook"){ 
      outlookIndex = i;
      setStatus(i,"‚è≥ Bitte Outlook-Tab schlie√üen!"); 
      setAction(i, `<button onclick="markOutlookClosed(${i})">Ich habe Outlook geschlossen</button>`); 
    } else { 
      setStatus(i,"‚è≥ Ge√∂ffnet"); 
      stepCompleted(); 
    }
  });

  if(popupBlockedDetected) showPopupHint();

  // Normale Tabs automatisch schlie√üen, Outlook bleibt offen
  const interval = setInterval(()=>{
    let allNormalClosed = true;
    tabs.forEach((t,i)=>{
      if(!t || t.type === "outlook") return;
      if(t.win && !t.win.closed){
        try{ t.win.close(); }catch(e){}
        allNormalClosed = false;
      } else {
        setStatus(i,"‚úÖ Geschlossen");
      }
    });
    if(allNormalClosed) clearInterval(interval);
  },300);
}

function markOutlookClosed(i){ 
  setStatus(i,"‚úÖ Geschlossen"); 
  setAction(i,""); 
  stepCompleted(); 
}

function checkAllClosed(){
  const allClosed = websites.every((w,i) => {
    const statusEl = document.getElementById(`status-${i}`);
    return statusEl && statusEl.textContent.includes("‚úÖ Geschlossen");
  });
  if(allClosed){
    const container = document.getElementById("continue-container");
    if(!container.innerHTML) container.innerHTML = `<button onclick="continueSetup()">Weiter</button>`;
  }
}

function continueSetup(){
  document.getElementById("continue-container").innerHTML="";
  const openBtn = document.getElementById("open-btn");
  if(openBtn) openBtn.remove();

  websites.forEach((w,i)=>{
    const card = document.getElementById(`status-${i}`).closest(".site-card");
    if(w.name !== "Microsoft-Account"){ if(card) card.remove(); }
    else { setStatus(i,""); setAction(i, `<button class="pop-button" onclick="loginMicrosoft(${i})">Bei Microsoft anmelden</button>`); }
  });

  centerMicrosoftCard();
  stepCompleted();
}

function centerMicrosoftCard(){
  const grid = document.getElementById("grid-container");
  const card = grid.querySelector(".site-card");
  const singleContainer = document.getElementById("single-card-container");

  if(card && grid.children.length === 1){
    grid.style.display = "none";
    singleContainer.style.display = "flex";
    singleContainer.appendChild(card);
    card.style.margin = "0";
    card.style.position = "relative";
    card.style.top = "0";
    card.style.transform = "none";
  }
}

function loginMicrosoft(i){
  const win = window.open("https://myaccount.microsoft.com/","_blank");
  if(!win){alert("Pop-ups blockiert!"); return;}
  setAction(i, `<span>‚è≥ Melde dich bei Microsoft an und kehre zur√ºck</span><br><button class="pop-button" onclick="confirmMicrosoftLogin(${i})">Anmeldung erfolgreich</button>`);
  stepCompleted();
}

function confirmMicrosoftLogin(i){
  setAction(i,"‚úÖ Anmeldung best√§tigt");
  setStatus(i,"‚úÖ Microsoft angemeldet");
  stepCompleted();
  setTimeout(()=>{
    const heading=document.querySelector("#container h2");
    if(heading) heading.textContent="Setup-Assistent abgeschlossen";
    const msCard=document.getElementById(`status-${i}`).closest(".site-card");
    if(msCard){
      msCard.style.transition="all 0.8s ease"; 
      msCard.style.padding="0"; msCard.style.width="220px"; msCard.style.height="50px";
      msCard.style.border="none"; msCard.style.borderRadius="8px"; msCard.style.display="flex";
      msCard.style.justifyContent="center"; msCard.style.alignItems="center";
      msCard.style.background="linear-gradient(45deg,#50e3c2,#4a90e2)";
      msCard.innerHTML=`<button onclick="openAllSites()">Setup-Assistent beenden</button>`;
    }
  },300);
}

function openAllSites() {
  showFinalizeOverlay();
  websites.forEach(w => { if(w.name !== "Microsoft-Account" && w.name !== "SharePoint") window.open(w.url,"_blank"); });
  const sharepoint = websites.find(w => w.name === "SharePoint");
  if(sharepoint){
    const focusHandler = () => {
      if(document.hasFocus()){
        const overlay = document.createElement('div');
        overlay.id = 'switch-overlay';
        overlay.style.position = 'fixed';
        overlay.style.inset = '0';
        overlay.style.background = 'rgba(0,0,0,0.95)';
        overlay.style.display = 'flex';
        overlay.style.justifyContent='center';
        overlay.style.alignItems='center';
        overlay.style.color = '#0ff';
        overlay.style.fontSize='2em';
        overlay.style.fontWeight='bold';
        overlay.style.zIndex='9999';
        overlay.style.textShadow='0 0 10px #0ff,0 0 30px #0ff';
        overlay.style.opacity = '0';
        overlay.style.transition = 'opacity 0.6s ease-in-out';
        overlay.innerHTML = `<span style="animation: pulseSwitch 1.2s ease-in-out infinite;">üåê Wechsel zu SharePoint‚Ä¶</span>`;
        document.body.appendChild(overlay);
        requestAnimationFrame(() => { overlay.style.opacity = '1'; });
        setTimeout(()=>{ overlay.style.opacity = '0'; setTimeout(()=>{ window.location.href = sharepoint.url; },600); },1500);
        window.removeEventListener('focus', focusHandler);
      }
    };
    window.addEventListener('focus', focusHandler);
  }
}

function updateClockAndDate(){
  const now = new Date();
  const h = String(now.getHours()).padStart(2,'0');
  const m = String(now.getMinutes()).padStart(2,'0');
  const s = String(now.getSeconds()).padStart(2,'0');
  document.getElementById("clock").textContent = `${h}:${m}:${s}`;
  const day = String(now.getDate()).padStart(2,'0');
  const month = String(now.getMonth() + 1).padStart(2,'0');
  const year = now.getFullYear();
  document.getElementById("date").textContent = `${day}.${month}.${year}`;
}

setInterval(updateClockAndDate,1000); updateClockAndDate();

const apiKey = "ad688baf24db25de764321fbad3a6e1e"; // API-Key einf√ºgen
const cities = ["Potsdam,de", "Treuenbrietzen,de"];

async function fetchWeather(city, elementId){
  try {
    const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&units=metric&lang=de&appid=${apiKey}`;
    const res = await fetch(url);
    const data = await res.json();

    if(data.cod !== 200){
      document.getElementById(elementId).textContent = `${city.split(",")[0]}: Wetter nicht verf√ºgbar`;
      return;
    }

    const temp = Math.round(data.main.temp);
    const desc = data.weather[0].description;

    // Optionale Map f√ºr Neon-Cyberpunk-Icons (falls eigene Icons vorhanden)
    const iconMap = {
      "klarer Himmel": "icons/cyber-sun.png",
      "leicht bew√∂lkt": "icons/cyber-cloud.png",
      "bedeckt": "icons/cyber-cloud.png",
      "Regen": "icons/cyber-rain.png",
      "Schnee": "icons/cyber-snow.png"
    };
    const iconUrl = iconMap[desc] || `https://openweathermap.org/img/wn/${data.weather[0].icon}.png`;

    document.getElementById(elementId).innerHTML = `
      <b>${city.split(",")[0]}</b>
      <div>
        <img src="${iconUrl}" alt="${desc}"> ${desc}, ${temp}¬∞C
      </div>
    `;
  } catch(e){
    document.getElementById(elementId).textContent = `${city.split(",")[0]}: Wetter nicht verf√ºgbar`;
  }
}

window.addEventListener('DOMContentLoaded', ()=>{
  cities.forEach((c,i)=>fetchWeather(c, `city${i+1}`));
});

window.addEventListener('DOMContentLoaded', ()=>{
  cities.forEach((c,i)=>fetchWeather(c, `city${i+1}`));
});

</script>
</body>
</html>
